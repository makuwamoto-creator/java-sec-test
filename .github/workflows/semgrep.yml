name: Java-CI-with-Security

on:
  push:
    branches: ["main"]  # mainã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚å®Ÿè¡Œ
  pull_request:
    branches: ["main"]  # mainã¸ã®pullãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚å®Ÿè¡Œ

jobs:
  semgrep-task:
    runs-on: ubuntu-latest
    # æ¨©é™ã®è¨­å®šï¼šSecurityã‚¿ãƒ–ã«çµæœã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã«å¿…è¦
    permissions:
      security-events: write

    #container:
    #  image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ä»®æƒ³ç’°å¢ƒã«ã‚³ãƒ”ãƒ¼

      # (A) Javaç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæœ¬ç•ªã‚‰ã—ã„CIã®ç¬¬ä¸€æ­©ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven' # ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½(.m2ãƒ•ã‚©ãƒ«ãƒ€)

      # (B) Mavenã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
      - name: Build with Maven spotbugs check
        run: mvn clean compile spotbugs:spotbugs

      # (C) Semgrepã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
      #- name: Run Semgrep scan
        # --error å¼•æ•°ã«ã‚ˆã‚Šã€è„†å¼±æ€§ç™ºè¦‹æ™‚ã«ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹
        # run: semgrep scan --config="p/java" --error
        
        # --rm -> å®Ÿè¡ŒãŒçµ‚ã‚ã£ãŸã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å³åº§ã«å‰Šé™¤ã›ã‚ˆ
        # Dockerã® ã€Œãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆï¼ˆVolume Mountï¼‰ã€
        # -v $(pwd):/src -> ä»Šã®å ´æ‰€ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ã€ã‚³ãƒ³ãƒ†ãƒŠã®/srcã«ãƒã‚¦ãƒ³ãƒˆ
        # $(pwd) : ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆã‚ãªãŸã®Javaã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´æ‰€ï¼‰
      #  run: docker run --rm -v $(pwd):/src semgrep/semgrep semgrep scan --config="p/java" --sarif --output=/src/semgrep.sarif

      # (D) Mavenã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
      #- name: Build with Maven
      #  run: mvn clean package

      #- name: Rename SARIF file
      #  # ç”Ÿæˆã•ã‚ŒãŸ .json ã‚’ GitHub ãŒèªè­˜ã§ãã‚‹ .sarif ã«ãƒªãƒãƒ¼ãƒ ã—ã¾ã™
      #  run: mv target/spotbugsSarif.json target/spotbugs.sarif

      # ğŸŒŸ XMLã‚’SARIFã«å¤‰æ›ã™ã‚‹ï¼ˆç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
      - name: Convert SpotBugs XML to SARIF
        uses: p0deje/spotbugs-action@v1
        with:
          # MavenãŒç”Ÿæˆã—ãŸXMLã‚’æŒ‡å®š
          path: target/spotbugsXml.xml
          # SARIFã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å
          output: target/spotbugs.sarif

      # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ­ã‚°ã§åå‰ãŒè¦‹ã‚Œã¾ã™ï¼‰
      - name: List target directory
        run: ls -l target/

      - name: Display SARIF
        run: cat target/spotbugs.sarif

      - name: Upload SARIF file
        # GitHubå…¬å¼ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€SARIFãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        uses: github/codeql-action/upload-sarif@v4
        # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
        with:
          sarif_file: target/spotbugs.sarif #semgrep.sarif
        # ã‚¹ã‚­ãƒ£ãƒ³ãŒå¤±æ•—ã—ã¦ã‚‚ï¼ˆè„†å¼±æ€§ãŒè¦‹ã¤ã‹ã£ã¦ã‚‚ï¼‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹è¨­å®š
        if: always()

      - name: Debug - List files
        run: ls -R $(pwd)  # ç¾åœ¨åœ°ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦è¡¨ç¤º

      - name: Upload Build Artifact
        # GitHubå…¬å¼ã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        uses: actions/upload-artifact@v4
        with:
          # ä¿å­˜ã™ã‚‹åå‰ï¼ˆGitHubä¸Šã§ã“ã®åå‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
          name: java-application-jar
          # ä¿å­˜ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
          # Mavenã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¯é€šå¸¸ target ãƒ•ã‚©ãƒ«ãƒ€ã«ä½œæˆã•ã‚Œã¾ã™
          path: target/*.jar